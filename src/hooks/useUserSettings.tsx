import { useState, useEffect } from "react";
import { supabase } from "@/integrations/supabase/client";

export interface UserSettings {
  activeCountry: string;
  activeCompetitors: string[];
  countryFlag: string;
  countryName: string;
  prioritizedOutlets: Array<{ name: string; active: boolean }>;
}

const COUNTRIES = [
  { code: 'AR', name: 'Argentina', flag: 'ðŸ‡¦ðŸ‡·' },
  { code: 'AU', name: 'Australia', flag: 'ðŸ‡¦ðŸ‡º' },
  { code: 'BE', name: 'Belgium', flag: 'ðŸ‡§ðŸ‡ª' },
  { code: 'BR', name: 'Brazil', flag: 'ðŸ‡§ðŸ‡·' },
  { code: 'BG', name: 'Bulgaria', flag: 'ðŸ‡§ðŸ‡¬' },
  { code: 'CA', name: 'Canada', flag: 'ðŸ‡¨ðŸ‡¦' },
  { code: 'CL', name: 'Chile', flag: 'ðŸ‡¨ðŸ‡±' },
  { code: 'CN', name: 'China', flag: 'ðŸ‡¨ðŸ‡³' },
  { code: 'CO', name: 'Colombia', flag: 'ðŸ‡¨ðŸ‡´' },
  { code: 'HR', name: 'Croatia', flag: 'ðŸ‡­ðŸ‡·' },
  { code: 'CZ', name: 'Czech Republic', flag: 'ðŸ‡¨ðŸ‡¿' },
  { code: 'DK', name: 'Denmark', flag: 'ðŸ‡©ðŸ‡°' },
  { code: 'EG', name: 'Egypt', flag: 'ðŸ‡ªðŸ‡¬' },
  { code: 'FI', name: 'Finland', flag: 'ðŸ‡«ðŸ‡®' },
  { code: 'FR', name: 'France', flag: 'ðŸ‡«ðŸ‡·' },
  { code: 'DE', name: 'Germany', flag: 'ðŸ‡©ðŸ‡ª' },
  { code: 'GR', name: 'Greece', flag: 'ðŸ‡¬ðŸ‡·' },
  { code: 'IN', name: 'India', flag: 'ðŸ‡®ðŸ‡³' },
  { code: 'ID', name: 'Indonesia', flag: 'ðŸ‡®ðŸ‡©' },
  { code: 'IL', name: 'Israel', flag: 'ðŸ‡®ðŸ‡±' },
  { code: 'IT', name: 'Italy', flag: 'ðŸ‡®ðŸ‡¹' },
  { code: 'JP', name: 'Japan', flag: 'ðŸ‡¯ðŸ‡µ' },
  { code: 'MY', name: 'Malaysia', flag: 'ðŸ‡²ðŸ‡¾' },
  { code: 'MX', name: 'Mexico', flag: 'ðŸ‡²ðŸ‡½' },
  { code: 'NL', name: 'Netherlands', flag: 'ðŸ‡³ðŸ‡±' },
  { code: 'NZ', name: 'New Zealand', flag: 'ðŸ‡³ðŸ‡¿' },
  { code: 'NO', name: 'Norway', flag: 'ðŸ‡³ðŸ‡´' },
  { code: 'PK', name: 'Pakistan', flag: 'ðŸ‡µðŸ‡°' },
  { code: 'PE', name: 'Peru', flag: 'ðŸ‡µðŸ‡ª' },
  { code: 'PH', name: 'Philippines', flag: 'ðŸ‡µðŸ‡­' },
  { code: 'PL', name: 'Poland', flag: 'ðŸ‡µðŸ‡±' },
  { code: 'PT', name: 'Portugal', flag: 'ðŸ‡µðŸ‡¹' },
  { code: 'RO', name: 'Romania', flag: 'ðŸ‡·ðŸ‡´' },
  { code: 'SA', name: 'Saudi Arabia', flag: 'ðŸ‡¸ðŸ‡¦' },
  { code: 'SG', name: 'Singapore', flag: 'ðŸ‡¸ðŸ‡¬' },
  { code: 'SK', name: 'Slovakia', flag: 'ðŸ‡¸ðŸ‡°' },
  { code: 'ZA', name: 'South Africa', flag: 'ðŸ‡¿ðŸ‡¦' },
  { code: 'KR', name: 'South Korea', flag: 'ðŸ‡°ðŸ‡·' },
  { code: 'ES', name: 'Spain', flag: 'ðŸ‡ªðŸ‡¸' },
  { code: 'SE', name: 'Sweden', flag: 'ðŸ‡¸ðŸ‡ª' },
  { code: 'CH', name: 'Switzerland', flag: 'ðŸ‡¨ðŸ‡­' },
  { code: 'TW', name: 'Taiwan', flag: 'ðŸ‡¹ðŸ‡¼' },
  { code: 'TH', name: 'Thailand', flag: 'ðŸ‡¹ðŸ‡­' },
  { code: 'TR', name: 'Turkey', flag: 'ðŸ‡¹ðŸ‡·' },
  { code: 'AE', name: 'UAE', flag: 'ðŸ‡¦ðŸ‡ª' },
  { code: 'GB', name: 'United Kingdom', flag: 'ðŸ‡¬ðŸ‡§' },
  { code: 'US', name: 'United States', flag: 'ðŸ‡ºðŸ‡¸' },
  { code: 'VN', name: 'Vietnam', flag: 'ðŸ‡»ðŸ‡³' },
];

export const useUserSettings = () => {
  const [settings, setSettings] = useState<UserSettings>({
    activeCountry: 'PT',
    activeCompetitors: ['F-35'],
    countryFlag: 'ðŸ‡µðŸ‡¹',
    countryName: 'Portugal',
    prioritizedOutlets: [],
  });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    loadSettings();

    const channel = supabase
      .channel('user-settings-changes')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'user_settings',
      }, () => loadSettings())
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, []);

  const loadSettings = async () => {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        setLoading(false);
        return;
      }

      const { data, error } = await supabase
        .from('user_settings')
        .select('active_country, active_competitors, prioritized_outlets')
        .eq('user_id', user.id)
        .maybeSingle();

      if (error && error.code !== 'PGRST116') {
        console.error('Error loading settings:', error);
      }

      const country = COUNTRIES.find(c => c.code === (data?.active_country || 'PT'));
      
      const outlets = data?.prioritized_outlets as unknown;
      const prioritizedOutlets = Array.isArray(outlets) ? outlets as Array<{ name: string; active: boolean }> : [];
      
      setSettings({
        activeCountry: data?.active_country || 'PT',
        activeCompetitors: data?.active_competitors || ['F-35'],
        countryFlag: country?.flag || 'ðŸ‡µðŸ‡¹',
        countryName: country?.name || 'Portugal',
        prioritizedOutlets,
      });
    } catch (error) {
      console.error('Error loading settings:', error);
    } finally {
      setLoading(false);
    }
  };

  return { settings, loading, refreshSettings: loadSettings };
};